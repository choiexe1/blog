---
title: 
tags:
  - java
  - programming
  - spring
  - transaction
  - propagation
publish: true
date: 2024-12-27
---
## 스프링 트랜잭션 전파 1 - 커밋, 롤백
트랜잭션이 둘 이상 있을 때는 어떻게 동작하는 지 알아보고, 스프링이 제공하는 트랜잭션 전파(propagation)라는 개념도 알아본다. 트랜잭션 전파를 이해하는 과정을 통해서 스프링 트랜잭션의 동작 과정도 좀 더 심도 있게 이해하는 것이 목표다.

먼저 간단한 스프링 트랜잭션 코드를 통해 기본 원리를 학습하고, 실제 예제를 통해 활용법을 학습한다.

```java
@SpringBootTest  
@Slf4j  
public class BasicTxTest {  
    @Autowired  
    PlatformTransactionManager txManager;  
  
    @TestConfiguration  
    static class Config {  
        @Bean  
        PlatformTransactionManager platformTransactionManager(DataSource dataSource) {  
            return new DataSourceTransactionManager(dataSource);  
        }  
    }  
  
    @Test  
    void commit() {  
        log.info("트랜잭션 시작");  
        TransactionStatus status = txManager.getTransaction(new DefaultTransactionAttribute());  
  
        log.info("트랜잭션 커밋 시작");  
        txManager.commit(status);  
        log.info("트랜잭션 커밋 완료");  
    }  
  
    @Test  
    void rollback() {  
        log.info("트랜잭션 시작");  
        TransactionStatus status = txManager.getTransaction(new DefaultTransactionAttribute());  
          
        log.info("트랜잭션 롤백 시작");  
        txManager.rollback(status);  
        log.info("트랜잭션 롤백 완료");  
    }  
}
```

위 코드는 단순히 스프링이 기본 등록하는 트랜잭션 매니저 대신 `DataSourceTransactionManager`를 빈으로 등록하고 사용한다. 커밋과 롤백이 정상적으로 작동하는지 확인하는 과정이고, 결과는 의도한대로 동작한다.

```java
@Test  
void double_commit() {  
    log.info("트랜잭션1 시작");  
    TransactionStatus tx1 = txManager.getTransaction(new DefaultTransactionAttribute());  
    log.info("트랜잭션1 커밋");  
    txManager.commit(tx1);  
  
    log.info("트랜잭션2 시작");  
    TransactionStatus tx2 = txManager.getTransaction(new DefaultTransactionAttribute());  
    log.info("트랜잭션2 커밋");  
    txManager.commit(tx2);  
}
```

`double_commit()`의 출력 결과를 살펴보면 다음과 같다.

```
2024-12-27T20:58:57.910+09:00  INFO 3513 --- [springtx] [    Test worker] hello.springtx.propagation.BasicTxTest   : 트랜잭션1 시작
2024-12-27T20:58:57.911+09:00 DEBUG 3513 --- [springtx] [    Test worker] o.s.j.d.DataSourceTransactionManager     : Creating new transaction with name [null]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
2024-12-27T20:58:57.913+09:00 DEBUG 3513 --- [springtx] [    Test worker] o.s.j.d.DataSourceTransactionManager     : Acquired Connection [HikariProxyConnection@903167192 wrapping conn0: url=jdbc:h2:mem:a298ca63-c14c-4b29-9f7d-bd7f7dcc42f5 user=SA] for JDBC transaction
2024-12-27T20:58:57.914+09:00 DEBUG 3513 --- [springtx] [    Test worker] o.s.j.d.DataSourceTransactionManager     : Switching JDBC Connection [HikariProxyConnection@903167192 wrapping conn0: url=jdbc:h2:mem:a298ca63-c14c-4b29-9f7d-bd7f7dcc42f5 user=SA] to manual commit
2024-12-27T20:58:57.914+09:00  INFO 3513 --- [springtx] [    Test worker] hello.springtx.propagation.BasicTxTest   : 트랜잭션1 커밋
2024-12-27T20:58:57.914+09:00 DEBUG 3513 --- [springtx] [    Test worker] o.s.j.d.DataSourceTransactionManager     : Initiating transaction commit
2024-12-27T20:58:57.914+09:00 DEBUG 3513 --- [springtx] [    Test worker] o.s.j.d.DataSourceTransactionManager     : Committing JDBC transaction on Connection [HikariProxyConnection@903167192 wrapping conn0: url=jdbc:h2:mem:a298ca63-c14c-4b29-9f7d-bd7f7dcc42f5 user=SA]
2024-12-27T20:58:57.915+09:00 DEBUG 3513 --- [springtx] [    Test worker] o.s.j.d.DataSourceTransactionManager     : Releasing JDBC Connection [HikariProxyConnection@903167192 wrapping conn0: url=jdbc:h2:mem:a298ca63-c14c-4b29-9f7d-bd7f7dcc42f5 user=SA] after transaction
2024-12-27T20:58:57.915+09:00  INFO 3513 --- [springtx] [    Test worker] hello.springtx.propagation.BasicTxTest   : 트랜잭션2 시작
2024-12-27T20:58:57.915+09:00 DEBUG 3513 --- [springtx] [    Test worker] o.s.j.d.DataSourceTransactionManager     : Creating new transaction with name [null]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT
2024-12-27T20:58:57.915+09:00 DEBUG 3513 --- [springtx] [    Test worker] o.s.j.d.DataSourceTransactionManager     : Acquired Connection [HikariProxyConnection@1834816004 wrapping conn0: url=jdbc:h2:mem:a298ca63-c14c-4b29-9f7d-bd7f7dcc42f5 user=SA] for JDBC transaction
2024-12-27T20:58:57.915+09:00 DEBUG 3513 --- [springtx] [    Test worker] o.s.j.d.DataSourceTransactionManager     : Switching JDBC Connection [HikariProxyConnection@1834816004 wrapping conn0: url=jdbc:h2:mem:a298ca63-c14c-4b29-9f7d-bd7f7dcc42f5 user=SA] to manual commit
2024-12-27T20:58:57.915+09:00  INFO 3513 --- [springtx] [    Test worker] hello.springtx.propagation.BasicTxTest   : 트랜잭션2 커밋
2024-12-27T20:58:57.915+09:00 DEBUG 3513 --- [springtx] [    Test worker] o.s.j.d.DataSourceTransactionManager     : Initiating transaction commit
2024-12-27T20:58:57.915+09:00 DEBUG 3513 --- [springtx] [    Test worker] o.s.j.d.DataSourceTransactionManager     : Committing JDBC transaction on Connection [HikariProxyConnection@1834816004 wrapping conn0: url=jdbc:h2:mem:a298ca63-c14c-4b29-9f7d-bd7f7dcc42f5 user=SA]
2024-12-27T20:58:57.915+09:00 DEBUG 3513 --- [springtx] [    Test worker] o.s.j.d.DataSourceTransactionManager     : Releasing JDBC Connection [HikariProxyConnection@1834816004 wrapping conn0: url=jdbc:h2:mem:a298ca63-c14c-4b29-9f7d-bd7f7dcc42f5 user=SA] after transaction
```

트랜잭션을 시작하면 커넥션 풀에서 `tx1`과 `tx2`가 동일한 커넥션을 획득하고, 커밋하고 반납하는 정상적인 흐름이다. 

```
Acquired Connection [HikariProxyConnection@903167192 wrapping conn0: url=jdbc:h2:mem:a298ca63-c14c-4b29-9f7d-bd7f7dcc42f5 user=SA] for JDBC transaction
Acquired Connection [HikariProxyConnection@1834816004 wrapping conn0: url=jdbc:h2:mem:a298ca63-c14c-4b29-9f7d-bd7f7dcc42f5 user=SA] for JDBC transaction
```

- HikariProxyConnection@903167192
- HikariProxyConnection@1834816004

로그를 살펴보면 이 두 커넥션은 물리적으로는 동일한 커넥션이지만, 다르게 보인다. 히카리 풀이 반환해주는 커넥션을 다루는 프록시인 `HikariProxyConnection`의 객체 주소가 다른 것이다. 결과적으로 동일한 `conn0` 커넥션을 사용한 것이다.

---
References: 김영한 스프링 DB 2편

Links to this page: 