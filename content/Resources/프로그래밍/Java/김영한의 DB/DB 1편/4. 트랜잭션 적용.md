---
title: 
tags:
  - programming
  - sql
  - database
  - lock
  - transaction
  - java
  - spring
publish: true
date: 2024-12-12
---
## 트랜잭션 적용 1
이전 [[3. 트랜잭션 이해]]에선 트랜잭션에 대한 개념과 오토 커밋, 수동 커밋의 차이 그리고 DB 락에 대해 학습했다.

이번엔 실제 어플리케이션에서 DB 트랜잭션을 사용해서 계좌이체 같이 원자성이 중요한 비즈니스 로직을 어떻게 구현하는지 알아본다.

먼저 트랜잭션 없이 단순하게 계좌이체 비즈니스 로직만 구현해본다.

```java title="MemberServiceV1.java"
@RequiredArgsConstructor  
public class MemberServiceV1 {  
    private final MemberRepositoryV1 memberRepository;  
  
    public void transfer(String fromId, String toId, int money) throws SQLException {  
        Member fromMember = memberRepository.findById(fromId);  
        Member toMember = memberRepository.findById(toId);  
  
        memberRepository.update(fromId, fromMember.getMoney() - money);  
        validation(toMember);  
        memberRepository.update(toId, toMember.getMoney() + money);  
    }  
  
    private static void validation(Member toMember) {  
        if (toMember.getMemberId().equals("ex")) {  
            throw new IllegalStateException("이체 중 예외 발생");  
        }  
    }  
}
```

`transfer()`는 `fromId`의 회원을 조회해서 `toId`의 회원에게 `money`만큼의 돈을 이체하는 로직이다. 예외 상황을 테스트 해보기 위해 `toId`가 `ex`인 경우 예외를 발생 시킨다.

```java title="MemberServiceV1Test.java"
/**  
 * 기본 동작, 트랜잭션이 없어서 문제 발생  
 */  
class MemberServiceV1Test {  
    public static final String MEMBER_A = "memberA";  
    public static final String MEMBER_B = "memberB";  
    public static final String MEMBER_EX = "ex";  
  
    private MemberRepositoryV1 memberRepositoryV1;  
    private MemberServiceV1 memberServiceV1;  
  
    @BeforeEach  
    void beforeEach() {  
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);  
        memberRepositoryV1 = new MemberRepositoryV1(dataSource);  
        memberServiceV1 = new MemberServiceV1(memberRepositoryV1);  
    }  
  
    @Test  
    @DisplayName("정상 이체")  
    void transfer() throws SQLException {  
        // GIVEN  
        Member memberA = new Member(MEMBER_A, 10000);  
        Member memberB = new Member(MEMBER_B, 10000);  
  
        memberRepositoryV1.save(memberA);  
        memberRepositoryV1.save(memberB);  
  
        // WHEN  
        memberServiceV1.transfer(memberA.getMemberId(), memberB.getMemberId(), 2000);  
  
        // THEN  
        Member findMemberA = memberRepositoryV1.findById(memberA.getMemberId());  
        Member findMemberB = memberRepositoryV1.findById(memberB.getMemberId());  
  
        Assertions.assertThat(findMemberA.getMoney()).isEqualTo(8000);  
        Assertions.assertThat(findMemberB.getMoney()).isEqualTo(12000);  
    }  
}
```

정상 이체 흐름의 테스트 코드는 잘 작동한다. 트랜잭션은 다음과 같이 트랜잭션 처리 중 예외가 발생할 때 진가를 발휘한다.

```java

```

---
References: 김영한의 스프링 DB 1편

Links to this page: [[3. 트랜잭션 이해]]