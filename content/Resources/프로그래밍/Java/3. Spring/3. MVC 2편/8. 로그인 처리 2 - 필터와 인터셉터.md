---
title: 
tags:
  - java
  - programming
  - spring
  - login
  - authentication
  - filter
  - interceptor
publish: true
date: 2024-11-30
---
## 서블릿 필터 - 소개
필터는 서블릿이 제공하는 기술이다. 앞서 [[7. 로그인 처리 1 - 쿠키와 세션|로그인 처리 1]]의 요구 사항을 다시 살펴보자.

```
- 홈 화면(로그인 전)
	- 회원 가입
	- 로그인
- 홈 화면(로그인 후)
	- 본인 이름(누구님 환영합니다.)
	- 상품 관리
	- 로그 아웃
- 보안 요구사항
	- 로그인 사용자만 상품에 접근하고, 관리할 수 있음
	- 로그인 하지 않은 사용자가 상품 관리에 접근하면 로그인 화면으로 이동
- 회원 가입, 상품 관리
```

**공통 관심사항**

요구사항을 보면 로그인 한 사용자만 상품 관리 페이지에 들어갈 수 있어야 한다. 앞에서 로그인을 하지 않은 사용자에게는 상품 관리 버튼이 보이지 않기 때문에 문제가 없어 보인다. 그런데 문제는 로그인 하지 않은 사용자도 `http://localhost:8080/items`을 호출하면 상품 관리 화면에 들어갈 수 있다는 점이다.

물론 상품 관리 컨트롤러에서 등록, 수정, 삭제, 조회 등 상품 관리의 모든 컨트롤러 로직에 로그인 여부를 확인하는 로직을 작성하면 된다. 그런데 이렇게하면 향후 추가 요구사항 등에 로그인과 관련된 서비스가 있다면 모두 똑같이 로그인 여부를 확인해야 하는 로직이 들어가야 된다는 점이다. 

더 큰 문제는 향후 로그인과 관련된 로직이 변경 될 경우 작성한 모든 로직을 수정해야 할 수도 있다.
이렇게 어플리케이션이 여러 로직에서 공통으로 관심이 있는 것을 공통 관심사(cross-cutting concern)이라 한다.

여기서는 등록, 수정, 삭제, 조회 등 여러 로직에서 공통으로 **인증**에 대해서 관심을 갖고 있다.

이러한 공통 관심사는 스프링의 [[스프링 입문 2#AOP (Aspect Oriented Programming)|AOP]]로도 해결할 수 있지만, 웹과 관련된 공통 관심사는 지금부터 설명할 서블릿 필터 또는 스프링 인터셉터를 사용하는 것이 좋다.

웹과 관련된 공통 관심사를 처리할 때는 HTTP 헤더나 URL의 정보들이 필요한데, 서블릿 필터나 스프링 인터셉터는 `HttpServletRequest`를 제공한다.


### 서블릿 필터
필터는 서블릿이 지원하는 수문장이다. 필터의 특성은 다음과 같다.

> 서블릿 필터는 클라이언트의 HTTP 요청에 대한 거름망 같은 것이다. 요청이 필터 조건에 부합하지 않으면 걸러낼 수 있다.

**필터 흐름**

```
HTTP 요청 -> WAS -> 필터 -> 서블릿 -> 컨트롤러
```

필터를 적용하면 필터가 호출 된 다음에 서블릿이 호출된다. 그래서 모든 고객의 요청 로그를 남기는 요구사항이 있다면 필터를 사용하면 된다. 참고로 필터는 특정 URL 패턴에 적용할 수 있다.

참고로 스프링을 사용하는 경우 여기서 말하는 서블릿은 스프링의 [[5. 스프링 MVC 구조 이해#DispatcherServlet 구조 살펴보기|디스패처 서블릿]]으로 생각하면 된다.

**필터 제한**

```
HTTP 요청 -> WAS -> 필터 -> 서블릿 -> 컨트롤러 // 로그인 사용자 흐름
HTTP 요청 -> WAS -> 필터(적절하지 않은 요청, 서블릿 호출 X) // 비 로그인 사용자 흐름
```

필터에서 적절하지 않은 요청을 판단하여 요청을 종료할 수 있다. 그래서 로그인 여부를 체크하기에 딱 좋다.

**필터 체인**

```
HTTP 요청 -> WAS -> 필터1 -> 필터2 -> 필터3 -> 서블릿 -> 컨트롤러
```

필터는 체인으로 구성되는데, 중간에 필터를 자유롭게 추가할 수 있다. 예를 들어 로그를 남기는 필터를 먼저 적용하고, 그 다음에 로그인 여부를 체크하는 필터를 만들 수 있다.

### 필터 인터페이스
```java
public interface Filter {
	public default void init(FilterConfig filterConfig) throws ServletException {}
	public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException;
	public default void destroy() {}
}
```

필터 인터페이스를 구현하고 등록하면 서블릿 컨테이너가 필터를 싱글톤 객체로 생성하고 관리한다.
- **init()**: 필터 초기화 메서드, 서블릿 컨테이너가 생성될 때 호출된다..
- **doFilter()**: 고객의 요청이 올 때 마다 해당 메서드가 호출된다. 필터의 로직을 구현하면 된다.
- **destroy()**: 필터 종료 메서드, 서블릿 컨테이너가 종료 될 때 호출된다.

## 서블릿 필터 - 요청 로깅 기능 구현
가장 단순한 필터인, 모든 요청을 로그로 남기는 필터를 개발하고 적용해본다. 먼저 `Filter` 인터페이스를 구현하는 클래스를 작성한다.


```java
@Slf4j  
public class LogFilter implements Filter {  
    @Override  
    public void init(FilterConfig filterConfig) throws ServletException {  
        log.info("log filter init");  
    }  
  
    @Override  
    public void destroy() {  
        log.info("log filter destroy");  
    }  
  
    @Override  
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)  
            throws IOException, ServletException {  
        log.info("log filter doFilter");  
        HttpServletRequest req = (HttpServletRequest) servletRequest;  
  
        String requestURI = req.getRequestURI();  
        String uuid = UUID.randomUUID().toString();  
  
        try {  
            log.info("REQUEST [{}][{}]", uuid, requestURI);  
            filterChain.doFilter(servletRequest, servletResponse);  
        } catch (Exception e) {  
            throw e;  
        } finally {  
            log.info("RESPONSE [{}][{}]", uuid, requestURI);  
        }  
  
    }  
}
```

- `doFilter()` 메서드에 요청과 응답 파라미터인 `ServletRequest`, `ServletResponse`는 `HttpServletRequest`, `HttpServletResponse`의 부모 클래스이다.
- 따라서 `Http` 관련 기능이 `HttpServletRequest`에 비해 부족하므로 다운 캐스팅을 통해 변경한다.
- 요청 URI와, UUID를 생성해서 로깅한다.
- 로직이 종료되면 `filterChain.doFilter(servletRequest, servletResponse)`를 통해 다음 필터를 호출한다.
- 다음 필터 호출이 끝나면 `finally`문 내부의 로그가 출력된다.

이 필터를 사용하기 위해서는 등록하는 과정이 필요하다. 등록 코드는 다음과 같다.

```java
@Configuration  
public class WebConfig {  
  
    @Bean  
    public FilterRegistrationBean<Filter> logFilter() {  
        FilterRegistrationBean<Filter> filterRegistrationBean = new FilterRegistrationBean<>();  
        filterRegistrationBean.setFilter(new LogFilter());  
        filterRegistrationBean.setOrder(1);  
        filterRegistrationBean.addUrlPatterns("/*");  
  
        return filterRegistrationBean;  
    }  
}
```
- `@Configuration` 어노테이션을 사용해서, 앱 설정 정보 클래스라는 것을 명시한다.
- `@Bean` 어노테이션을 사용해서 스프링 빈을 등록한다.
- `Filter` 구현체를 어플리케이션에 등록하려면 `FilterRegistrationBean<Filter>`가 필요하다.
- `setFilter()`를 통해 앞서 구현한 필터를 등록한다.
- `setOrder()`를 통해서 필터의 적용 순서를 명시한다.
- `addUrlPatterns()`를 통해 필터가 적용될 URL 패턴을 명시할 수 있다. 위의 코드에서는 모든 경로에서 적용된다. ("\/*")

---
References: 김영한의 스프링 MVC 2편

Links to this page: [[7. 로그인 처리 1 - 쿠키와 세션]], [[스프링 입문 2]], [[5. 스프링 MVC 구조 이해]]