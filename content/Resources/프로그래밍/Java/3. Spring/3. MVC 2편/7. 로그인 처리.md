---
title: 
tags:
  - java
  - programming
  - spring
  - cookie
  - session
  - authentication
publish: true
date: 2024-11-29
---
## 로그인 요구사항
```
- 홈 화면(로그인 전)
	- 회원 가입
	- 로그인
- 홈 화면(로그인 후)
	- 본인 이름(누구님 환영합니다.)
	- 상품 관리
	- 로그 아웃
- 보안 요구사항
	- 로그인 사용자만 상품에 접근하고, 관리할 수 있음
	- 로그인 하지 않은 사용자가 상품 관리에 접근하면 로그인 화면으로 이동
- 회원 가입, 상품 관리
```

## 패키지 구조 설계
현재 패키지 구조를 먼저 살펴보면 다음과 같다.

- hello.login
	- domain
		- item
		- member
		- login
	- web
		- item
		- member
		- login

**도메인이 가장 중요하다.**

> 도메인은 화면, UI, 기술 인프라 등등의 영역은 제외한 시스템이 구현해야 하는 핵심 비즈니스 업무 영역을 말한다.

향후 `web`을 다른 기술로 바꾸어도 도메인은 그대로 유지할 수 있어야 한다. 이렇게 하려면 `web`은 `domain`을 알고 있지만, `domain`은 `web`을 모르도록 설계해야 한다. 이것을 `web`은 `domain`을 의존하지만 `domain`은 `web`을 의존하지 않는다고 표현한다.

예를 들어 `web` 패키지를 모두 삭제해도 `domain`에는 전혀 영향이 없도록 의존관계를 설계하는 것이 중요하다. 반대로 이야기하면 `domain`은 `web`을 참조하면 안된다.

또 다른 예를 들어보면, `web`을 모두 `Restful API`로 변경하여도 `domain`에는 전혀 영향이 없어야 한다.

## 로그인 구현
로그인 폼 부분이나 로그인 서비스에서 계정명, 패스워드를 비교하는 부분은 제외하고 로그인 컨트롤러의 코드만 살펴본다.

```java
@PostMapping("/login")  
public String login(@Validated @ModelAttribute("loginForm") LoginForm form, BindingResult bindingResult) {  
    if (bindingResult.hasErrors()) {  
        return "login/loginForm";  
    }  
  
    Member member = loginService.login(form.getLoginId(), form.getPassword());  
  
    if (member == null) {  
        bindingResult.reject("login fail", "아이디 또는 비밀번호가 맞지 않습니다.");  
        return "login/loginForm";  
    }  
  
    // TODO: 로그인 성공 처리  
    return "redirect:/";  
}
```

웹 계층의 로그인에서 가장 중요한 비즈니스 로직이다. 

- 매개변수인 `LoginForm`에 대한 검증 작업
- 검증에 실패하면 `BindingResult`에 에러가 저장됨
- 에러가 있으면 기존 화면(login/loginForm)으로 이동
- 로그인 서비스를 통해 로그인 시도, `null`일 경우 `BindingResult`로 오브젝트 에러 생성 후 기존 화면으로 이동
- 성공시 홈으로 리다이렉트

### 쿠키 사용
유저가 로그인에 성공했다면, 로그인 성공에 대한 상태를 계속해서 유지해야한다. 어떻게 상태를 유지할 수 있을까? 여기선 쿠키를 사용해서 로그인을 처리하는 방법을 알아본다.

1. 로그인에 성공하면 서버에선 클라이언트에게 쿠키를 전달한다.
2. 쿠키를 전달 받은 클라이언트는 해당 쿠키를 매 요청에 쿠키를 함께 전달한다.
3. 서버는 클라이언트가 매 요청마다 보낸 쿠키를 파싱해서, 로그인 상태임을 확인한다.

**쿠키에는 영속 쿠키와 세션 쿠키가 있다.**

- 영속 쿠키: 만료 날짜를 입력하면 해당 날짜까지 유지
- 세션 쿠키: 만료 날짜를 생략하면 브라우저 종료 까지만 유지

브라우저 종료시 로그아웃이 되길 기대하므로, 우리에게 필요한 것은 세션 쿠키이다.


---
References: 김영한의 스프링 MVC 2편

Links to this page: 